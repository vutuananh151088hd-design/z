name: "Godot iOS Build"
on: [push, workflow_dispatch]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Godot 4.3.0
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.3.0
          use-dotnet: false

      - name: Install Godot iOS Templates
        run: |
          mkdir -p "$HOME/Library/Application Support/Godot/export_templates/4.3.stable"
          curl -L "https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz" -o templates.tpz
          mv templates.tpz templates.zip
          unzip -q templates.zip -d temp_templates
          cp temp_templates/templates/ios.zip "$HOME/Library/Application Support/Godot/export_templates/4.3.stable/ios.zip"

      - name: Export Xcode Project
        run: |
          mkdir -p build/ios
          godot --headless --path . --export-release "iOS" build/ios/project.xcodeproj
          
      - name: Build Unsigned IPA
        run: |
          cd build/ios
          # Lấy tên Project và Scheme (Sửa lệnh jq để lấy phần tử đầu tiên chuẩn xác)
          PROJECT_FILE=$(ls -d *.xcodeproj | head -n 1)
          SCHEME_NAME=$(xcodebuild -list -project "$PROJECT_FILE" -json | jq -r '.project.schemes[0]')
          
          echo "Building: $PROJECT_FILE with Scheme: $SCHEME_NAME"
          
          # Build ép buộc lưu vào thư mục hiện tại để không bị lạc file .app
          xcodebuild -project "$PROJECT_FILE" \
            -scheme "$SCHEME_NAME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath ./DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            ENTITLEMENTS_ALLOWED=NO \
            OBJROOT=$(pwd)/build \
            SYMROOT=$(pwd)/build
          
          # Đóng gói IPA từ file .app tìm được
          mkdir -p Payload
          APP_PATH=$(find build -name "*.app" | head -n 1)
          echo "Found App at: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -vr ../../game.ipa Payload/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-game-ipa
          path: game.ipa
